# 本地开发配置说明

## 云函数本地调试

### 重要提示
⚠️ **本地开发时，必须开启"云函数本地调试"才能正确调用云函数！**

### 开启步骤

#### 方法一：工具栏开启（推荐）
1. 打开微信开发者工具
2. 点击工具栏的"云开发"按钮
3. 在云开发控制台中，点击"本地调试"
4. 开启"云函数本地调试"开关

#### 方法二：菜单开启
1. 点击菜单栏"工具" → "云开发"
2. 选择"云函数本地调试"
3. 确认开启

### 开启后的效果

**开启前：**
```
调用云函数 → 无响应或报错
console: 云函数调用失败
```

**开启后：**
```
调用云函数 → 正常返回结果
console: 云函数返回: { errMsg: "cloud.callFunction:ok", result: {...} }
```

### 本地调试 vs 云端调试

| 特性 | 本地调试 | 云端调试 |
|-----|---------|---------|
| 调试速度 | 快 | 较慢 |
| 需要部署 | 否 | 是 |
| 代码修改 | 实时生效 | 需重新部署 |
| 适用场景 | 开发阶段 | 测试/生产 |

### 本地调试配置

#### 1. 确认云函数目录结构
```
cloudfunctions/
├── login/
│   ├── index.js
│   ├── package.json
│   └── config.json
├── getUserStats/
│   ├── index.js
│   ├── package.json
│   └── config.json
└── checkIn/
    ├── index.js
    ├── package.json
    └── config.json
```

#### 2. 安装云函数依赖
```bash
# 在每个云函数目录下执行
cd cloudfunctions/login
npm install

cd ../getUserStats
npm install

cd ../checkIn
npm install
```

#### 3. 开启本地调试
- 工具栏 → 云开发 → 本地调试 → 开启

### 常见问题

#### Q1: 开启本地调试后仍然无法调用云函数

**可能原因：**
1. 云函数依赖未安装
2. 云函数代码有语法错误
3. 云开发环境未初始化

**解决方案：**
```bash
1. 检查云函数目录下是否有 node_modules
2. 右键云函数 → 在终端中打开 → npm install
3. 查看控制台是否有错误信息
4. 确认 app.js 中的云环境 ID 正确
```

#### Q2: 本地调试和云端调试有什么区别？

**本地调试：**
- 云函数在本地运行
- 修改代码后立即生效
- 无需上传部署
- 适合快速开发和调试

**云端调试：**
- 云函数在云端运行
- 需要上传部署后才能生效
- 真实的生产环境
- 适合测试和发布

#### Q3: 真机预览需要开启本地调试吗？

**不需要！**
- 真机预览/体验版/正式版都使用云端的云函数
- 本地调试只影响开发者工具中的调试
- 真机测试前需要确保云函数已部署到云端

#### Q4: 如何切换本地调试和云端调试？

**切换方法：**
```
工具栏 → 云开发 → 本地调试 → 开关切换
```

**建议：**
- 开发阶段：开启本地调试
- 测试阶段：关闭本地调试，使用云端
- 真机测试：必须使用云端（部署后）

### 开发工作流程

#### 本地开发阶段
```
1. 开启云函数本地调试
2. 修改云函数代码
3. 在开发者工具中测试
4. 查看控制台日志
5. 重复 2-4 直到功能完成
```

#### 云端测试阶段
```
1. 关闭云函数本地调试
2. 右键云函数 → 上传并部署
3. 等待部署完成
4. 在开发者工具中测试
5. 确认功能正常
```

#### 真机测试阶段
```
1. 确保所有云函数已部署到云端
2. 点击"预览"生成二维码
3. 手机扫码打开小程序
4. 测试各项功能
5. 查看云函数日志排查问题
```

### 调试技巧

#### 1. 查看本地调试日志
```javascript
// 在云函数中添加日志
console.log('云函数被调用');
console.log('参数:', event);
console.log('返回结果:', result);
```

#### 2. 使用断点调试
```
1. 在云函数代码中设置断点
2. 开启本地调试
3. 调用云函数
4. 在断点处暂停，查看变量
```

#### 3. 模拟不同场景
```javascript
// 在云函数中模拟不同的 openid
const openid = event.testOpenid || wxContext.OPENID;

// 在小程序中传入测试 openid
wx.cloud.callFunction({
  name: 'login',
  data: {
    testOpenid: 'test-openid-123'
  }
});
```

### 环境变量配置

#### 本地开发环境
```javascript
// miniprogram/config/index.js
module.exports = {
  // 本地开发配置
  development: {
    cloudEnvId: 'cloud1-5g9hlytr7a58a6f7',
    debug: true
  },
  // 生产环境配置
  production: {
    cloudEnvId: 'cloud1-5g9hlytr7a58a6f7',
    debug: false
  }
};
```

### 最佳实践

#### 1. 开发阶段
- ✅ 开启本地调试
- ✅ 频繁测试和修改
- ✅ 使用 console.log 调试
- ✅ 在开发者工具中测试

#### 2. 测试阶段
- ✅ 部署到云端
- ✅ 关闭本地调试
- ✅ 在开发者工具中测试云端版本
- ✅ 使用预览功能真机测试

#### 3. 发布阶段
- ✅ 确认所有云函数已部署
- ✅ 关闭本地调试
- ✅ 完整测试所有功能
- ✅ 上传代码并提交审核

### 注意事项

1. **本地调试只影响开发者工具**
   - 真机预览/体验版/正式版始终使用云端云函数
   - 真机测试前必须部署云函数

2. **数据库操作**
   - 本地调试时，数据库操作仍然是在云端进行
   - 不会影响真实数据

3. **依赖安装**
   - 本地调试需要在云函数目录下安装依赖
   - 使用 `npm install` 安装

4. **环境隔离**
   - 建议使用不同的云环境进行开发和生产
   - 避免开发数据污染生产环境

### 快速检查清单

开发前检查：
- [ ] 云函数本地调试已开启
- [ ] 云函数依赖已安装
- [ ] 云环境 ID 配置正确
- [ ] 数据库集合已创建

部署前检查：
- [ ] 所有云函数代码已完成
- [ ] 本地测试通过
- [ ] 关闭本地调试
- [ ] 部署所有云函数到云端

发布前检查：
- [ ] 云端测试通过
- [ ] 真机预览测试通过
- [ ] 所有功能正常
- [ ] 日志无错误信息

### 相关文档

- [微信小程序云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [云函数开发指南](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions.html)
- `/真机调试排查指南.md` - 真机调试问题排查
- `/数据库初始化说明.md` - 数据库初始化指南
