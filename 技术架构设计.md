# "我要戒烟"小程序技术架构设计

## 1. 架构概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                 │
│                  (微信小程序客户端)                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      接入层                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 微信登录 │  │ 云函数   │  │ 云存储   │  │ 广告SDK  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 用户模块 │  │ 签到模块 │  │ 统计模块 │  │ 证书模块 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 电子烟   │  │ 文章模块 │  │ 分享模块 │  │ 广告模块 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 云数据库 │  │ 云存储   │  │ 缓存层   │  │ 日志系统 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈总览

| 层级 | 技术选型 | 说明 |
|-----|---------|------|
| **前端框架** | 微信小程序原生 | 官方支持,性能最优 |
| **UI组件库** | Vant Weapp | 轻量级,组件丰富 |
| **状态管理** | 全局状态 + 页面状态 | 简单场景无需引入复杂框架 |
| **动画引擎** | Canvas 2D + Animation API | 原生支持,性能好 |
| **后端服务** | 微信云开发 | 无需自建服务器 |
| **数据库** | 云数据库(MongoDB) | NoSQL,灵活扩展 |
| **存储服务** | 云存储 | 图片/视频存储 |
| **云函数** | Node.js 12+ | 业务逻辑处理 |
| **广告服务** | 微信广告组件 | 官方广告SDK |
| **数据统计** | 微信数据分析 + 自定义埋点 | 用户行为分析 |

---

## 2. 前端架构设计

### 2.1 目录结构

```
quitsmoking/
├── cloudfunctions/              # 云函数目录
│   ├── login/                   # 登录云函数
│   ├── checkIn/                 # 签到云函数
│   ├── getUserStats/            # 获取用户统计
│   ├── generateCertificate/     # 生成证书
│   ├── makeUpCheckIn/           # 补签逻辑
│   ├── recordPuff/              # 记录吸烟行为
│   └── getArticles/             # 获取文章列表
├── miniprogram/                 # 小程序目录
│   ├── app.js                   # 小程序入口
│   ├── app.json                 # 全局配置
│   ├── app.wxss                 # 全局样式
│   ├── pages/                   # 页面目录
│   │   ├── home/                # 首页
│   │   ├── cigarette/           # 电子烟互动页
│   │   ├── certificate/         # 荣誉证书页
│   │   ├── refuse/              # 拒烟神器页
│   │   ├── methods/             # 戒烟方法页
│   │   ├── article/             # 文章详情页
│   │   ├── profile/             # 个人中心页
│   │   ├── calendar/            # 签到日历页
│   │   └── settings/            # 设置页
│   ├── components/              # 组件目录
│   │   ├── cigarette-canvas/    # 电子烟Canvas组件
│   │   ├── certificate-canvas/  # 证书Canvas组件
│   │   ├── smoke-particle/      # 烟雾粒子组件
│   │   ├── checkin-calendar/    # 签到日历组件
│   │   ├── stats-card/          # 统计卡片组件
│   │   ├── article-card/        # 文章卡片组件
│   │   └── badge-list/          # 勋章列表组件
│   ├── utils/                   # 工具函数
│   │   ├── util.js              # 通用工具函数
│   │   ├── date.js              # 日期处理
│   │   ├── storage.js           # 本地存储封装
│   │   ├── request.js           # 云函数请求封装
│   │   ├── canvas.js            # Canvas工具函数
│   │   └── animation.js         # 动画工具函数
│   ├── services/                # 业务服务层
│   │   ├── user.js              # 用户服务
│   │   ├── checkin.js           # 签到服务
│   │   ├── stats.js             # 统计服务
│   │   ├── certificate.js       # 证书服务
│   │   ├── cigarette.js         # 电子烟服务
│   │   └── article.js           # 文章服务
│   ├── config/                  # 配置文件
│   │   ├── index.js             # 全局配置
│   │   ├── constants.js         # 常量定义
│   │   └── ad.js                # 广告配置
│   ├── assets/                  # 静态资源
│   │   ├── images/              # 图片资源
│   │   ├── icons/               # 图标资源
│   │   └── audios/              # 音频资源
│   └── styles/                  # 全局样式
│       ├── variables.wxss       # 样式变量
│       └── common.wxss          # 公共样式
└── project.config.json          # 项目配置
```

### 2.2 核心模块设计

#### 2.2.1 应用入口(app.js)

**职责**: 应用初始化、全局状态管理、云开发配置

**关键功能**:
- 云开发环境初始化
- 用户登录状态检查
- 全局数据管理
- 广告组件预加载

#### 2.2.2 服务层设计

**用户服务(services/user.js)**
- `getUserInfo()`: 获取用户信息
- `updateUserInfo()`: 更新用户信息
- `setQuitDate()`: 设置戒烟日期
- `getUserStats()`: 获取用户统计数据

**签到服务(services/checkin.js)**
- `checkIn()`: 每日签到
- `makeUpCheckIn()`: 补签
- `getCheckinRecords()`: 获取签到记录
- `checkTodayCheckin()`: 检查今日签到状态

**证书服务(services/certificate.js)**
- `generateCertificate()`: 生成证书
- `getCertificateLevel()`: 获取证书等级
- `saveCertificateToAlbum()`: 保存证书到相册
- `shareCertificate()`: 分享证书

**电子烟服务(services/cigarette.js)**
- `recordPuff()`: 记录吸烟次数
- `recordShake()`: 记录抖灰次数
- `recordNewCigarette()`: 记录再来一根
- `shareCigarette()`: 送烟给好友

**文章服务(services/article.js)**
- `getArticleList()`: 获取文章列表
- `getArticleDetail()`: 获取文章详情
- `collectArticle()`: 收藏文章
- `likeArticle()`: 点赞文章

### 2.3 工具函数设计

#### 日期工具(utils/date.js)
- 日期格式化
- 日期差值计算
- 日历数据生成

#### Canvas工具(utils/canvas.js)
- 圆角矩形绘制
- 渐变背景绘制
- 文字自动换行
- Canvas转图片

#### 动画工具(utils/animation.js)
- 签到动画
- 烟雾粒子系统
- 烟花特效
- 过渡动画

---

## 3. 后端架构设计

### 3.1 云数据库设计

#### 3.1.1 数据库集合

**users(用户表)**
```javascript
{
  _openid: "用户openid",                    // 微信用户唯一标识
  nickName: "昵称",                         // 用户昵称
  avatarUrl: "头像URL",                     // 用户头像地址
  quitDate: "2026-01-01",                  // 开始戒烟日期(YYYY-MM-DD)
  dailyCigarettes: 20,                     // 戒烟前每日吸烟量(支)
  cigarettePrice: 15,                      // 单包香烟价格(元)
  cigarettesPerPack: 20,                   // 每包香烟支数
  makeUpCount: 3,                          // 本月剩余补签次数
  lastResetMonth: "2026-01",               // 上次重置补签次数的月份(YYYY-MM)
  continuousDays: 10,                      // 连续签到天数
  totalCheckin: 50,                        // 累计签到次数
  settings: {                              // 用户设置
    reminderEnabled: true,                 // 是否开启签到提醒
    reminderTime: "09:00",                 // 提醒时间
    showInRanking: true,                    // 是否在排行榜显示
    notifySurprise: true,                   // 是否开启惊喜提醒
    notifyArticle: false,                   // 是否开启文章提醒
    customRefuseText: '戒烟中,请勿劝烟!',    // 自定义拒绝劝烟文本
  },
  createTime: Date,                        // 创建时间
  updateTime: Date                         // 更新时间
}
```

**checkins(签到表)**
```javascript
{
  _openid: "用户openid",                    // 用户唯一标识
  date: "2026-01-14",                      // 签到日期(YYYY-MM-DD)
  timestamp: 1705219800000,                // 签到时间戳(毫秒)
  isMakeUp: false,                         // 是否为补签(true:补签, false:正常签到)
  continuousDays: 10,                      // 签到时的连续天数
  totalDays: 50,                           // 签到时的累计天数
  createTime: Date                         // 创建时间
}
```

**cigarettes(电子烟记录表)**
```javascript
{
  _openid: "用户openid",                    // 用户唯一标识
  date: "2026-01-14",                      // 记录日期(YYYY-MM-DD)
  puffCount: 50,                           // 吸一口次数
  shakeCount: 10,                          // 抖灰次数(摇一摇)
  newCigaretteCount: 5,                    // 再来一根次数
  shareCount: 2,                           // 分享次数
  totalDuration: 1800,                     // 总使用时长(秒)
  createTime: Date,                        // 创建时间
  updateTime: Date                         // 更新时间
}
```

**certificates(证书记录表)**
```javascript
{
  _openid: "用户openid",                    // 用户唯一标识
  days: 30,                                // 戒烟天数
  level: "intermediate",                   // 证书等级(beginner/intermediate/advanced/expert/master)
  levelName: "中级证书",                    // 证书等级名称
  imageUrl: "cloud://xxx.png",             // 证书图片云存储地址
  savedMoney: 450,                         // 节省金额(元)
  savedCigarettes: 600,                    // 少吸香烟数(支)
  healthIndex: 65,                         // 健康指数(0-100)
  createTime: Date                         // 生成时间
}
```

**articles(文章表)**
```javascript
{
  title: "文章标题",                        // 文章标题
  category: "scientific",                  // 文章分类(scientific/psychology/lifestyle/coping)
  categoryName: "科学戒烟",                 // 分类名称
  summary: "摘要",                          // 文章摘要(150字以内)
  content: "<p>内容</p>",                   // 文章内容(富文本HTML)
  coverImage: "cloud://xxx.jpg",           // 封面图片云存储地址
  author: "管理员",                         // 作者
  tags: ["科学", "方法"],                   // 标签数组
  viewCount: 1000,                         // 浏览次数
  likeCount: 50,                           // 点赞次数
  collectCount: 30,                        // 收藏次数
  status: "published",                     // 状态(draft:草稿, published:已发布, archived:已归档)
  publishTime: Date,                       // 发布时间
  createTime: Date,                        // 创建时间
  updateTime: Date                         // 更新时间
}
```

**collections(用户收藏表)**
```javascript
{
  _openid: "用户openid",                    // 用户唯一标识
  articleId: "文章ID",                      // 文章ID
  articleTitle: "文章标题",                 // 文章标题(冗余字段,便于查询)
  createTime: Date                         // 收藏时间
}
```

**likes(用户点赞表)**
```javascript
{
  _openid: "用户openid",                    // 用户唯一标识
  articleId: "文章ID",                      // 文章ID
  articleTitle: "文章标题",                 // 文章标题(冗余字段,便于查询)
  createTime: Date                         // 收藏时间
}
```

**badges(勋章记录表)**
```javascript
{
  _openid: "用户openid",                    // 用户唯一标识
  badgeType: "month_warrior",              // 勋章类型(唯一标识)
  badgeName: "月度勇士",                    // 勋章名称
  days: 30,                                // 解锁所需天数
  icon: "🥉",                               // 勋章图标(emoji)
  description: "连续戒烟30天",              // 勋章描述
  unlockTime: Date                         // 解锁时间
}
```

**shares(分享记录表)**
```javascript
{
  _openid: "用户openid",                    // 用户唯一标识
  shareType: "certificate",                // 分享类型(certificate:证书, article:文章, achievement:成就)
  targetId: "目标ID",                       // 分享目标的ID(证书ID/文章ID等)
  shareTime: Date,                         // 分享时间
  clickCount: 5,                           // 点击次数
  convertCount: 2                          // 转化次数(通过分享链接注册的用户数)
}
```

#### 3.1.2 索引设计

| 集合 | 索引字段 | 索引类型 | 说明 |
|-----|---------|---------|------|
| users | _openid | 唯一索引 | 用户唯一标识 |
| checkins | _openid + date | 联合唯一索引 | 防止重复签到 |
| checkins | date | 普通索引 | 按日期查询 |
| cigarettes | _openid + date | 联合唯一索引 | 每日记录唯一 |
| certificates | _openid | 普通索引 | 查询用户证书 |
| articles | category | 普通索引 | 分类查询 |
| articles | publishTime | 普通索引 | 时间排序 |
| collections | _openid + articleId | 联合唯一索引 | 防止重复收藏 |
| badges | _openid | 普通索引 | 查询用户勋章 |

### 3.2 云函数设计

#### 3.2.1 云函数列表

| 云函数名 | 功能 | 输入参数 | 返回值 |
|---------|------|---------|--------|
| login | 用户登录 | - | openid, success |
| getUserStats | 获取用户统计 | - | 用户数据、统计信息 |
| updateUserInfo | 更新用户信息 | 用户数据 | success |
| setQuitDate | 设置戒烟日期 | quitDate | success |
| checkIn | 每日签到 | - | 签到结果、连续天数 |
| makeUpCheckIn | 补签 | date | 补签结果 |
| getCheckinRecords | 获取签到记录 | year, month | 签到记录列表 |
| generateCertificate | 生成证书 | days, level | 证书数据 |
| recordPuff | 记录吸烟行为 | type, count | success |
| getArticles | 获取文章列表 | category, page | 文章列表 |
| getArticleDetail | 获取文章详情 | articleId | 文章详情 |
| collectArticle | 收藏文章 | articleId | success |
| likeArticle | 点赞文章 | articleId | success |

#### 3.2.2 云函数核心逻辑

**checkIn(签到)**
1. 检查今日是否已签到
2. 获取昨日签到记录
3. 计算连续签到天数
4. 添加签到记录
5. 检查并解锁勋章
6. 返回签到结果

**makeUpCheckIn(补签)**
1. 检查补签次数
2. 验证日期有效性(7天内)
3. 检查该日期是否已签到
4. 计算连续天数
5. 添加补签记录
6. 扣减补签次数

**generateCertificate(生成证书)**
1. 获取用户信息
2. 计算健康收益数据
3. 保存证书记录
4. 返回证书数据

### 3.3 数据库权限设计

```json
{
  "permissions": {
    "users": {
      "read": "doc._openid == auth.openid",
      "write": "doc._openid == auth.openid"
    },
    "checkins": {
      "read": "doc._openid == auth.openid",
      "write": false
    },
    "certificates": {
      "read": "doc._openid == auth.openid",
      "write": false
    },
    "articles": {
      "read": true,
      "write": false
    }
  }
}
```

---

## 4. 核心功能实现方案

### 4.1 电子烟烟雾效果

**技术方案**: Canvas 2D + 粒子系统

**实现步骤**:
1. 创建Canvas节点
2. 初始化粒子数组(30个粒子)
3. 每个粒子包含: 位置、速度、半径、透明度、生命值
4. 使用requestAnimationFrame更新粒子状态
5. 粒子向上飘动,透明度逐渐降低
6. 绘制粒子到Canvas

**性能优化**:
- 限制粒子数量(30个)
- 及时清理生命值为0的粒子
- 使用离屏Canvas预渲染

### 4.2 证书Canvas生成

**技术方案**: Canvas 2D绘制 + 导出图片

**实现步骤**:
1. 创建Canvas节点(750x1000)
2. 绘制渐变背景(根据证书等级)
3. 绘制装饰元素(边框、图标)
4. 绘制文字内容(昵称、天数、数据)
5. 使用canvasToTempFilePath导出图片
6. 保存到相册或分享

**关键技术**:
- 渐变背景绘制
- 文字自动换行
- 网络图片加载
- 高清图片导出(dpr适配)

### 4.3 签到日历

**技术方案**: 自定义日历组件

**实现步骤**:
1. 计算月份天数和起始星期
2. 生成日历数据结构
3. 从数据库获取签到记录
4. 标记已签到日期
5. 支持点击日期补签

**数据结构**:
```javascript
{
  year: 2026,
  month: 1,
  days: [
    { date: 1, isChecked: true, isMakeUp: false },
    { date: 2, isChecked: true, isMakeUp: false },
    { date: 3, isChecked: false, isMakeUp: false }
  ]
}
```

### 4.4 摇一摇功能

**技术方案**: 加速度传感器API

**实现步骤**:
1. 监听加速度变化`wx.onAccelerometerChange`
2. 计算加速度变化幅度
3. 设置阈值判断是否摇动
4. 触发对应动作(点火/抖灰)
5. 添加防抖处理

**关键代码**:
```javascript
wx.startAccelerometer({
  interval: 'game'
});

wx.onAccelerometerChange((res) => {
  const { x, y, z } = res;
  const acceleration = Math.sqrt(x*x + y*y + z*z);
  
  if (acceleration > 2.5) {
    this.handleShake();
  }
});
```

### 4.5 拒烟神器横屏

**技术方案**: 页面配置 + 全屏API

**实现步骤**:
1. 页面配置强制横屏
```json
{
  "pageOrientation": "landscape",
  "navigationStyle": "custom"
}
```
2. 隐藏导航栏实现全屏
3. 自定义返回按钮
4. 监听屏幕旋转事件

---

## 5. 数据流设计

### 5.1 用户登录流程

```
用户打开小程序
    ↓
调用wx.cloud.callFunction(login)
    ↓
云函数获取openid
    ↓
查询users表
    ↓
用户存在? → 是 → 返回用户信息
    ↓ 否
创建新用户记录
    ↓
返回用户信息
    ↓
保存到全局状态
```

### 5.2 签到流程

```
用户点击签到按钮
    ↓
检查今日是否已签到
    ↓
已签到? → 是 → 提示已签到
    ↓ 否
调用checkIn云函数
    ↓
计算连续签到天数
    ↓
添加签到记录
    ↓
检查是否解锁勋章
    ↓
返回签到结果
    ↓
播放签到动画
    ↓
更新页面数据
```

### 5.3 证书生成流程

```
用户点击生成证书
    ↓
调用generateCertificate云函数
    ↓
获取用户数据
    ↓
计算健康收益
    ↓
保存证书记录
    ↓
返回证书数据
    ↓
Canvas绘制证书
    ↓
导出图片
    ↓
显示保存/分享选项
```

---

## 6. 性能优化方案

### 6.1 前端优化

**图片优化**
- 使用WebP格式
- 图片懒加载
- 压缩图片质量
- CDN加速

**代码优化**
- 按需加载组件
- 减少setData频率
- 避免频繁操作DOM
- 使用节流防抖

**渲染优化**
- 使用虚拟列表
- 减少页面层级
- 避免过度渲染
- 使用骨架屏

**缓存策略**
- 本地存储用户数据
- 缓存文章列表
- 缓存签到记录
- 设置合理过期时间

### 6.2 后端优化

**数据库优化**
- 合理设计索引
- 避免全表扫描
- 使用聚合查询
- 数据分页加载

**云函数优化**
- 减少云函数调用次数
- 批量处理数据
- 使用缓存
- 异步处理非关键逻辑

**并发控制**
- 使用数据库事务
- 乐观锁防止并发
- 限流控制

---

## 7. 安全方案

### 7.1 数据安全

- 使用云开发权限控制
- 敏感数据加密存储
- 防止SQL注入
- 输入数据校验

### 7.2 业务安全

- 防刷签到(时间校验)
- 防刷补签(次数限制)
- 防刷广告(观看验证)
- 防恶意分享

### 7.3 隐私保护

- 用户数据隔离
- 遵守隐私政策
- 最小化数据收集
- 支持数据删除

---

## 8. 监控与日志

### 8.1 性能监控

- 页面加载时间
- 接口响应时间
- 云函数执行时间
- 错误率统计

### 8.2 业务监控

- 日活跃用户数
- 签到率
- 证书生成量
- 文章阅读量
- 广告点击率

### 8.3 日志系统

- 错误日志记录
- 用户行为日志
- 云函数调用日志
- 关键操作审计

---

## 9. 部署方案

### 9.1 开发环境

- 本地开发工具
- 测试云环境
- 模拟数据

### 9.2 测试环境

- 体验版小程序
- 测试云环境
- 真实数据测试

### 9.3 生产环境

- 正式版小程序
- 生产云环境
- 数据备份策略
- 灰度发布

---

## 10. 扩展性设计

### 10.1 功能扩展

- 插件化架构
- 模块解耦
- 配置化管理
- 版本兼容

### 10.2 数据扩展

- 灵活的数据模型
- 支持字段扩展
- 数据迁移方案

### 10.3 性能扩展

- 云函数自动扩容
- 数据库读写分离
- CDN加速
- 负载均衡

---

**文档版本**: v1.0  
**创建日期**: 2026-01-14  
**最后更新**: 2026-01-14  
**文档状态**: 待评审
