# 真机调试排查指南

## 问题描述
真机预览时没有创建新用户记录

## 可能原因及解决方案

### 1. 云函数未部署或版本不是最新

**检查方法：**
- 在微信开发者工具中，右键 `cloudfunctions/login` 文件夹
- 查看是否有"上传并部署"选项
- 查看云函数列表中 `login` 的更新时间

**解决方案：**
```bash
1. 右键 cloudfunctions/login
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成（查看控制台输出）
4. 确认部署成功后重新测试
```

### 2. 数据库集合未创建

**检查方法：**
- 打开微信开发者工具
- 点击"云开发"按钮
- 进入"数据库"页面
- 查看是否存在 `users` 集合

**解决方案：**
```bash
方法一：使用 initDB 云函数自动创建
1. 部署 initDB 云函数
2. 在云开发控制台 → 云函数 → initDB → 云端测试
3. 点击"测试"按钮运行
4. 查看返回结果确认创建成功

方法二：手动创建
1. 云开发控制台 → 数据库
2. 点击"添加集合"
3. 输入集合名称：users
4. 点击确定
```

### 3. 云环境 ID 配置错误

**检查方法：**
查看 `miniprogram/app.js` 中的云环境 ID：
```javascript
cloudEnvId: 'cloud1-5g9hlytr7a58a6f7'
```

**解决方案：**
1. 打开云开发控制台
2. 查看顶部的环境 ID
3. 确保与 `app.js` 中配置的一致
4. 如果不一致，修改 `app.js` 中的配置

### 4. 云函数权限问题

**检查方法：**
查看云函数日志：
- 云开发控制台 → 云函数 → login → 日志
- 查看是否有权限相关错误

**解决方案：**
```bash
1. 确保云函数有访问数据库的权限
2. 检查云函数的运行角色配置
3. 如有权限错误，在云开发控制台调整权限设置
```

### 5. 真机网络问题

**检查方法：**
- 查看手机是否连接网络
- 查看小程序控制台是否有网络错误
- 尝试调用其他云函数测试网络

**解决方案：**
```bash
1. 确保手机网络正常
2. 尝试切换 WiFi 或 4G/5G
3. 检查是否有防火墙或代理拦截
```

### 6. OpenID 获取失败

**检查方法：**
在 `app.js` 的 `checkLogin` 方法中查看日志：
```javascript
console.log('login云函数返回:', res);
console.log('openid:', result.openid);
```

**解决方案：**
```bash
1. 确保小程序已发布或在体验版中测试
2. 开发版可能无法获取真实 openid
3. 使用"预览"功能生成二维码，用手机扫码测试
```

## 调试步骤

### 第一步：检查云函数部署状态

1. **打开微信开发者工具**
2. **查看云函数列表**
   - 点击左侧"云开发"图标
   - 进入"云函数"页面
   - 找到 `login` 云函数
   - 查看更新时间是否是最新的

3. **重新部署云函数**
   ```
   右键 cloudfunctions/login
   → 上传并部署：云端安装依赖
   → 等待部署完成
   ```

### 第二步：检查数据库集合

1. **打开云开发控制台**
   - 点击"云开发"按钮
   - 进入"数据库"页面

2. **检查集合是否存在**
   - 查看是否有 `users` 集合
   - 如果没有，使用 `initDB` 云函数创建

3. **检查集合权限**
   - 点击 `users` 集合
   - 查看权限设置
   - 建议设置为"仅创建者可读写"

### 第三步：查看云函数日志

1. **打开云函数日志**
   ```
   云开发控制台
   → 云函数
   → login
   → 日志
   ```

2. **查看最近的调用记录**
   - 查看是否有 "用户不存在，创建新用户" 日志
   - 查看是否有错误信息
   - 记录错误详情

### 第四步：真机调试

1. **使用预览功能**
   ```
   点击工具栏"预览"按钮
   → 生成二维码
   → 用手机微信扫码
   → 打开小程序
   ```

2. **查看手机端日志**
   - 在开发者工具中查看"调试器" → "Console"
   - 查看 `login云函数返回:` 日志
   - 确认是否有错误信息

3. **查看数据库记录**
   ```
   云开发控制台
   → 数据库
   → users 集合
   → 查看是否有新记录
   ```

## 常见错误及解决方案

### 错误1：集合不存在
```
Error: collection 'users' not found
```

**解决方案：**
1. 部署并运行 `initDB` 云函数
2. 或手动在云开发控制台创建 `users` 集合

### 错误2：权限不足
```
Error: permission denied
```

**解决方案：**
1. 检查数据库集合权限设置
2. 确保设置为"仅创建者可读写"
3. 检查云函数运行角色权限

### 错误3：云环境未初始化
```
Error: cloud init error
```

**解决方案：**
1. 检查 `app.js` 中的云环境 ID
2. 确保云开发已开通
3. 重新初始化云开发环境

### 错误4：网络超时
```
Error: request timeout
```

**解决方案：**
1. 检查网络连接
2. 尝试切换网络
3. 增加云函数超时时间

## 验证方法

### 方法1：查看数据库
1. 打开云开发控制台
2. 进入数据库 → users 集合
3. 查看是否有新增记录
4. 确认记录的 `_openid` 字段

### 方法2：查看日志
1. 查看小程序控制台日志
2. 确认输出：
   ```
   login云函数返回: { errMsg: "cloud.callFunction:ok", result: {...} }
   登录成功, openid: oMtNG15U3j7helNeqHjHTHQa4QfA
   ```

### 方法3：查看云函数日志
1. 云开发控制台 → 云函数 → login → 日志
2. 查看是否有 "用户不存在，创建新用户" 日志
3. 确认创建成功

## 完整检查清单

- [ ] 云函数 `login` 已部署到云端
- [ ] 云函数 `initDB` 已部署到云端
- [ ] 数据库集合 `users` 已创建
- [ ] 云环境 ID 配置正确
- [ ] 数据库权限设置正确
- [ ] 手机网络连接正常
- [ ] 使用"预览"功能测试（不是"真机调试"）
- [ ] 查看云函数日志确认调用成功
- [ ] 查看数据库确认记录创建

## 推荐的测试流程

1. **开发者工具测试**
   ```
   编译 → 查看控制台日志 → 确认登录成功
   ```

2. **真机预览测试**
   ```
   点击"预览" → 扫码打开 → 查看日志 → 检查数据库
   ```

3. **体验版测试**
   ```
   上传代码 → 设为体验版 → 扫码打开 → 验证功能
   ```

## 联系支持

如果以上方法都无法解决问题，请提供以下信息：

1. 云函数日志截图
2. 小程序控制台日志
3. 数据库集合列表截图
4. 错误信息详情

## 相关文件

- `/cloudfunctions/login/index.js` - 登录云函数
- `/cloudfunctions/initDB/index.js` - 数据库初始化云函数
- `/miniprogram/app.js` - 小程序主文件
- `/数据库初始化说明.md` - 数据库初始化文档
