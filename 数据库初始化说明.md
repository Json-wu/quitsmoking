# 数据库初始化说明

## 概述

小程序启动时会自动检查数据库集合是否存在，如果缺少必需的集合，会尝试自动初始化。

## 自动初始化流程

1. **小程序启动** → 检查数据库集合
2. **发现缺少集合** → 自动调用 `initDB` 云函数
3. **云函数创建集合** → 初始化完成

## 必需的数据库集合

| 集合名称 | 说明 | 是否必需 |
|---------|------|---------|
| users | 用户表 | ✓ 必需 |
| checkins | 签到表 | ✓ 必需 |
| cigarettes | 电子烟记录表 | ✓ 必需 |
| certificates | 证书记录表 | ✓ 必需 |
| articles | 文章表 | ✓ 必需 |
| collections | 用户收藏表 | 可选 |
| likes | 用户点赞表 | 可选 |
| badges | 勋章记录表 | 可选 |
| shares | 分享记录表 | 可选 |

## 部署步骤

### 方法一：自动初始化（推荐）

1. **部署 initDB 云函数**
   ```bash
   # 在微信开发者工具中
   右键 cloudfunctions/initDB → 上传并部署：云端安装依赖
   ```

2. **启动小程序**
   - 小程序会自动检测并创建缺少的集合
   - 初始化成功后会显示提示

### 方法二：手动创建

如果自动初始化失败，可以手动创建集合：

1. **打开云开发控制台**
   - 在微信开发者工具中点击"云开发"按钮
   - 进入"数据库"页面

2. **创建集合**
   - 点击"添加集合"按钮
   - 依次创建以下集合：
     - `users`
     - `checkins`
     - `cigarettes`
     - `certificates`
     - `articles`
     - `collections`
     - `likes`
     - `badges`
     - `shares`

3. **设置权限**
   - 所有集合权限设置为：**仅创建者可读写**

### 方法三：云端测试初始化

1. **部署 initDB 云函数**（同方法一）

2. **在云开发控制台测试**
   - 进入"云函数"页面
   - 找到 `initDB` 云函数
   - 点击"云端测试"
   - 点击"测试"按钮运行
   - 查看返回结果确认初始化成功

## 检查初始化状态

### 在小程序中检查

小程序启动时会在控制台输出：

```
开始检查数据库集合...
✓ 集合 users (用户表) 存在
✓ 集合 checkins (签到表) 存在
...
✓ 数据库检查通过
```

### 在云开发控制台检查

1. 打开"数据库"页面
2. 查看集合列表
3. 确认所有必需的集合都已创建

## 常见问题

### Q: 小程序提示"数据库未初始化"

**A:** 可能原因：
1. `initDB` 云函数未部署
2. 云函数权限不足
3. 网络连接问题

**解决方法：**
1. 检查云函数是否已部署
2. 尝试手动创建集合（方法二）
3. 查看云函数日志排查错误

### Q: 自动初始化失败

**A:** 
1. 查看小程序控制台的错误信息
2. 在云开发控制台查看 `initDB` 云函数日志
3. 确认云开发环境 ID 配置正确
4. 使用方法二手动创建集合

### Q: 如何重新初始化数据库

**A:**
1. 在云开发控制台删除所有集合
2. 重新启动小程序，会自动重新初始化
3. 或者在云开发控制台手动运行 `initDB` 云函数

## 数据库索引建议

创建集合后，建议添加以下索引以提升查询性能：

### users 表
- `_openid`: 唯一索引

### checkins 表
- `_openid + date`: 联合唯一索引
- `date`: 普通索引

### cigarettes 表
- `_openid + date`: 联合唯一索引

### certificates 表
- `_openid`: 普通索引

### articles 表
- `category`: 普通索引
- `status`: 普通索引

### collections 表
- `_openid`: 普通索引
- `articleId`: 普通索引

### badges 表
- `_openid`: 普通索引

## 技术实现

### 检查逻辑

```javascript
// utils/dbInit.js
const checkCollections = async () => {
  // 尝试查询每个集合
  // 如果查询失败，说明集合不存在
  // 返回检查结果
};
```

### 初始化逻辑

```javascript
// cloudfunctions/initDB/index.js
exports.main = async (event, context) => {
  // 遍历所有集合配置
  // 检查集合是否存在
  // 不存在则创建
  // 返回初始化结果
};
```

### 集成到小程序

```javascript
// app.js
onLaunch() {
  this.initCloud();      // 初始化云开发
  this.checkDatabase();  // 检查数据库
  this.checkLogin();     // 检查登录
}
```

## 注意事项

1. **首次部署**：首次部署时必须先部署 `initDB` 云函数
2. **权限设置**：确保云函数有创建集合的权限
3. **环境 ID**：确认 `app.js` 中的云环境 ID 配置正确
4. **网络环境**：初始化需要网络连接，确保网络畅通
5. **数据备份**：重新初始化会清空数据，请提前备份

## 相关文件

- `/miniprogram/utils/dbInit.js` - 数据库检查工具
- `/cloudfunctions/initDB/index.js` - 数据库初始化云函数
- `/miniprogram/app.js` - 集成数据库检查逻辑
- `/技术架构设计.md` - 数据库设计文档

## 更新日志

- 2026-01-14: 创建数据库自动初始化功能
