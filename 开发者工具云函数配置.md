# 开发者工具云函数配置指南

## 问题描述
开发者工具模拟器中，即使云函数已部署，仍需要开启本地调试才能访问云函数。

## 根本原因
微信开发者工具默认优先使用**本地云函数**，而不是云端已部署的云函数。

## 解决方案

### 方案一：使用云端云函数（推荐用于测试）

#### 步骤1：关闭本地调试
```
工具栏 → 云开发 → 关闭"云函数本地调试"
```

#### 步骤2：刷新云函数列表
```
1. 点击工具栏"云开发"按钮
2. 进入"云函数"页面
3. 点击右上角"刷新"按钮
4. 确认云函数列表显示已部署的云函数
```

#### 步骤3：清除缓存重新编译
```
1. 菜单栏 → 工具 → 清除缓存 → 全部清除
2. 点击"编译"按钮重新编译
3. 测试云函数调用
```

### 方案二：使用本地云函数（推荐用于开发）

#### 步骤1：确保云函数依赖已安装
```bash
# 在每个云函数目录下执行
cd cloudfunctions/login
npm install

cd ../getUserStats
npm install

cd ../checkIn
npm install

cd ../setQuitDate
npm install

cd ../initDB
npm install
```

#### 步骤2：开启本地调试
```
工具栏 → 云开发 → 开启"云函数本地调试"
```

#### 步骤3：重新编译
```
点击"编译"按钮
```

### 方案三：配置云函数调用优先级

在 `app.js` 中添加云函数调用配置：

```javascript
// app.js
wx.cloud.init({
  env: this.globalData.cloudEnvId,
  traceUser: true,
  // 添加以下配置
  config: {
    // 强制使用云端云函数
    env: this.globalData.cloudEnvId
  }
});
```

## 不同场景的推荐配置

### 场景1：快速开发调试
```
✅ 开启本地调试
✅ 修改代码实时生效
✅ 快速迭代
```

**操作：**
1. 开启云函数本地调试
2. 确保依赖已安装
3. 直接修改代码测试

### 场景2：测试云端版本
```
✅ 关闭本地调试
✅ 使用云端已部署的云函数
✅ 模拟真实环境
```

**操作：**
1. 部署所有云函数到云端
2. 关闭云函数本地调试
3. 清除缓存重新编译
4. 测试功能

### 场景3：真机预览测试
```
✅ 必须使用云端云函数
✅ 本地调试设置不影响真机
```

**操作：**
1. 确保云函数已部署到云端
2. 点击"预览"生成二维码
3. 手机扫码测试

## 常见问题

### Q1: 为什么关闭本地调试后云函数调用失败？

**可能原因：**
1. 云函数未部署到云端
2. 云函数部署版本不是最新
3. 云环境 ID 配置错误

**解决方法：**
```bash
1. 右键每个云函数 → 上传并部署：云端安装依赖
2. 等待所有云函数部署完成
3. 刷新云函数列表
4. 清除缓存重新编译
```

### Q2: 本地调试和云端调试有什么区别？

| 特性 | 本地调试 | 云端调试 |
|-----|---------|---------|
| 代码位置 | 本地 | 云端 |
| 修改生效 | 立即 | 需重新部署 |
| 依赖安装 | 本地 npm install | 云端自动安装 |
| 适用场景 | 开发阶段 | 测试/生产 |
| 真机访问 | 不可用 | 可用 |

### Q3: 如何确认使用的是云端还是本地云函数？

**查看方法：**
```
1. 在云函数中添加日志：
   console.log('云函数版本: v1.0.0');

2. 本地代码改为：
   console.log('云函数版本: v2.0.0-local');

3. 调用云函数查看日志输出
   - 输出 v1.0.0 → 使用云端
   - 输出 v2.0.0-local → 使用本地
```

### Q4: 开发者工具和真机使用的云函数一样吗？

**不一样！**
- **开发者工具**：可以选择本地或云端
- **真机预览/体验版/正式版**：始终使用云端

**重要提示：**
真机测试前，必须确保所有云函数已部署到云端！

## 推荐的开发流程

### 阶段1：功能开发（使用本地调试）
```
1. 开启云函数本地调试
2. 修改云函数代码
3. 在模拟器中测试
4. 查看控制台日志
5. 重复 2-4 直到功能完成
```

### 阶段2：集成测试（使用云端）
```
1. 部署所有云函数到云端
2. 关闭云函数本地调试
3. 清除缓存重新编译
4. 在模拟器中完整测试
5. 确认所有功能正常
```

### 阶段3：真机测试
```
1. 确认云函数已部署
2. 点击"预览"生成二维码
3. 手机扫码测试
4. 查看云函数日志排查问题
```

### 阶段4：发布上线
```
1. 完成所有测试
2. 上传代码
3. 提交审核
4. 发布正式版
```

## 调试技巧

### 技巧1：添加版本标识
```javascript
// 在云函数中添加版本信息
exports.main = async (event, context) => {
  console.log('云函数版本: 2026-01-16 v1.0');
  console.log('运行环境:', process.env.NODE_ENV);
  
  // 业务逻辑
  return {
    success: true,
    version: '1.0',
    timestamp: Date.now()
  };
};
```

### 技巧2：使用环境变量区分
```javascript
// 判断是否在本地运行
const isLocal = process.env.USER_CODE_ROOT ? false : true;
console.log('运行环境:', isLocal ? '本地' : '云端');
```

### 技巧3：查看云函数日志
```
云开发控制台 → 云函数 → 选择云函数 → 日志
```

## 最佳实践

### 开发阶段
- ✅ 使用本地调试，快速迭代
- ✅ 频繁测试，及时发现问题
- ✅ 使用 console.log 调试
- ✅ 保持代码简洁

### 测试阶段
- ✅ 部署到云端测试
- ✅ 关闭本地调试
- ✅ 模拟真实环境
- ✅ 完整功能测试

### 发布阶段
- ✅ 确认所有云函数已部署
- ✅ 真机完整测试
- ✅ 检查云函数日志
- ✅ 确认无错误后发布

## 快速检查清单

### 本地开发检查
- [ ] 云函数本地调试已开启
- [ ] 云函数依赖已安装（npm install）
- [ ] 云环境 ID 配置正确
- [ ] 数据库集合已创建

### 云端测试检查
- [ ] 所有云函数已部署到云端
- [ ] 云函数本地调试已关闭
- [ ] 缓存已清除
- [ ] 重新编译后测试

### 真机测试检查
- [ ] 云函数已部署到云端
- [ ] 使用"预览"功能（不是真机调试）
- [ ] 手机网络正常
- [ ] 查看云函数日志确认调用

## 总结

**核心要点：**
1. 开发阶段：开启本地调试，快速开发
2. 测试阶段：关闭本地调试，使用云端
3. 真机测试：必须使用云端云函数
4. 遇到问题：查看云函数日志排查

**记住：**
- 开发者工具可以选择本地或云端
- 真机始终使用云端云函数
- 部署后要清除缓存重新编译
