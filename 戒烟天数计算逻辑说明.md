# 戒烟天数计算逻辑说明

## 修改概述

将戒烟天数的计算逻辑从**基于累计签到天数**改为**基于戒烟开始日期**计算。

## 核心变更

### 1. 戒烟天数计算方式

**修改前：**
```javascript
// 戒烟天数 = 累计签到天数
let quitDays = totalCheckin;
```

**修改后：**
```javascript
// 戒烟天数 = 从戒烟开始日期到今天的天数（包含当天）
let quitDays = 0;
if (user.quitDate) {
  const quitDate = new Date(user.quitDate);
  const now = new Date();
  quitDate.setHours(0, 0, 0, 0);
  now.setHours(0, 0, 0, 0);
  // +1 表示包含当天
  quitDays = Math.floor((now - quitDate) / (1000 * 60 * 60 * 24)) + 1;
  if (quitDays < 0) quitDays = 0;
}
```

### 2. 健康收益计算

所有健康收益数据都基于戒烟天数计算：

| 数据项 | 计算公式 | 说明 |
|-------|---------|------|
| **戒烟天数** | `(今天 - 戒烟开始日期) + 1` | 包含当天 |
| **节省香烟数** | `戒烟天数 × 每日吸烟量` | 基于戒烟天数 |
| **节省金额** | `(节省香烟数 / 每包支数) × 每包价格` | 基于戒烟天数 |
| **健康指数** | `min(100, floor(戒烟天数 / 3.65))` | 365天达到100% |
| **减少尼古丁** | `节省香烟数 × 1.2` | 基于戒烟天数 |

### 3. 签到功能独立

签到功能与戒烟天数解耦：

- ✅ 签到记录连续签到天数
- ✅ 签到记录累计签到天数
- ❌ 签到不再影响戒烟天数
- ❌ 签到不再影响健康收益计算

## 修改的文件

### 1. `/cloudfunctions/getUserStats/index.js`

**修改内容：**
- 戒烟天数基于 `user.quitDate` 计算
- 计算时包含当天（+1）
- 健康收益基于戒烟天数计算

**关键代码：**
```javascript
// 计算戒烟天数：基于戒烟开始日期
let quitDays = 0;
if (user.quitDate) {
  const quitDate = new Date(user.quitDate);
  const now = new Date();
  quitDate.setHours(0, 0, 0, 0);
  now.setHours(0, 0, 0, 0);
  quitDays = Math.floor((now - quitDate) / (1000 * 60 * 60 * 24)) + 1;
  if (quitDays < 0) quitDays = 0;
}

// 计算健康收益（基于戒烟天数）
const savedCigarettes = quitDays * user.dailyCigarettes;
const savedMoney = ((savedCigarettes / user.cigarettesPerPack) * user.cigarettePrice).toFixed(2);
const healthIndex = Math.min(100, Math.floor(quitDays / 3.65));
```

### 2. `/miniprogram/pages/index/index.js`

**修改内容：**
- `loadData` 方法使用云函数返回的戒烟天数
- `handleCheckin` 方法不再更新戒烟天数
- 健康收益基于戒烟天数计算

**关键代码：**
```javascript
// loadData 方法
const quitDays = globalData.quitDays || 0;
const healthStats = this.calculateHealthStats(quitDays);

// handleCheckin 方法
// 签到成功，只更新签到相关数据
this.setData({
  hasCheckedToday: true,
  currentStreak: result.continuousDays,
  totalCheckin: result.totalDays
  // 不再更新 quitDays
});
```

## 数据流向

```
用户注册
    ↓
设置戒烟开始日期（默认当天）
    ↓
云函数 getUserStats
    ↓
计算戒烟天数 = (今天 - 戒烟开始日期) + 1
    ↓
计算健康收益
    ├─ 节省香烟数 = 戒烟天数 × 每日吸烟量
    ├─ 节省金额 = (节省香烟数 / 20) × 香烟价格
    ├─ 健康指数 = min(100, floor(戒烟天数 / 3.65))
    └─ 减少尼古丁 = 节省香烟数 × 1.2
    ↓
返回给前端显示
```

## 签到功能说明

签到功能现在完全独立：

### 签到记录的数据
- **连续签到天数**：连续签到的天数
- **累计签到天数**：总共签到的天数
- **签到日期**：每次签到的日期记录

### 签到不影响的数据
- ❌ 戒烟天数（只由戒烟开始日期决定）
- ❌ 节省金额（基于戒烟天数）
- ❌ 少抽香烟数（基于戒烟天数）
- ❌ 健康指数（基于戒烟天数）

### 签到的作用
- ✅ 记录用户的坚持情况
- ✅ 用于排行榜展示
- ✅ 用于勋章解锁条件
- ✅ 用于激励用户每日打卡

## 示例场景

### 场景1：新用户注册

```
2026-01-16 注册
戒烟开始日期：2026-01-16

当天显示：
- 戒烟天数：1天（包含当天）
- 节省香烟：20支（假设每日20支）
- 节省金额：15元（假设每包15元）
- 健康指数：0%（需要365天才能达到100%）
```

### 场景2：连续签到

```
2026-01-16 注册并签到
2026-01-17 签到
2026-01-18 签到

2026-01-18 显示：
- 戒烟天数：3天（2026-01-16 到 2026-01-18）
- 连续签到：3天
- 累计签到：3天
- 节省香烟：60支
- 节省金额：45元
```

### 场景3：中断签到

```
2026-01-16 注册并签到
2026-01-17 签到
2026-01-18 未签到
2026-01-19 签到

2026-01-19 显示：
- 戒烟天数：4天（2026-01-16 到 2026-01-19）✓
- 连续签到：1天（中断后重新开始）
- 累计签到：3天（总共签到3次）
- 节省香烟：80支（基于4天）✓
- 节省金额：60元（基于4天）✓
```

### 场景4：修改戒烟开始日期

```
原戒烟日期：2026-01-10
修改为：2026-01-01
当前日期：2026-01-16

修改后显示：
- 戒烟天数：16天（2026-01-01 到 2026-01-16）
- 节省香烟：320支
- 节省金额：240元
- 健康指数：4%
```

### 场景5：修改基础设置

```
原设置：
- 每日吸烟量：20支
- 香烟价格：15元/包

修改为：
- 每日吸烟量：30支
- 香烟价格：20元/包

戒烟天数：10天（不变）
修改后：
- 节省香烟：300支（10 × 30）
- 节省金额：300元（300 / 20 × 20）
```

## 优势

### 1. 更符合实际
- 戒烟天数反映真实的戒烟时长
- 不依赖于用户是否每天签到
- 即使忘记签到，戒烟天数也在增长

### 2. 数据独立
- 签到功能独立，用于记录坚持情况
- 戒烟天数独立，反映真实戒烟时长
- 两者互不影响，逻辑清晰

### 3. 用户体验
- 用户不会因为忘记签到而"损失"戒烟天数
- 健康收益持续增长，更有激励作用
- 签到作为额外的打卡激励

## 注意事项

### 1. 戒烟开始日期的重要性
- 戒烟开始日期是计算的基础
- 用户注册时默认设置为当天
- 用户可以在设置中修改

### 2. 时区处理
- 所有日期计算都设置为0点
- 避免时区差异导致的计算错误
- 确保跨天计算的准确性

### 3. 数据一致性
- 云函数计算戒烟天数
- 前端使用云函数返回的数据
- 避免前后端计算不一致

### 4. 边界情况
- 戒烟开始日期晚于当前日期：天数为0
- 未设置戒烟日期：天数为0
- 当天注册：天数为1（包含当天）

## 测试建议

### 测试用例1：新用户注册
1. 注册新用户
2. 检查戒烟天数是否为1
3. 检查健康收益是否正确计算

### 测试用例2：跨天测试
1. 设置戒烟日期为昨天
2. 检查戒烟天数是否为2
3. 检查健康收益是否翻倍

### 测试用例3：签到测试
1. 签到成功
2. 检查签到天数增加
3. 检查戒烟天数不变（基于日期）

### 测试用例4：修改设置
1. 修改每日吸烟量和价格
2. 保存设置
3. 返回首页检查健康收益是否更新

### 测试用例5：修改戒烟日期
1. 修改戒烟开始日期
2. 检查戒烟天数是否重新计算
3. 检查健康收益是否更新

## 部署步骤

1. **部署云函数**
   ```
   右键 cloudfunctions/getUserStats
   → 上传并部署：云端安装依赖
   ```

2. **清除缓存**
   ```
   菜单栏 → 工具 → 清除缓存 → 全部清除
   ```

3. **重新编译**
   ```
   点击"编译"按钮
   ```

4. **测试验证**
   - 检查首页戒烟天数显示
   - 测试签到功能
   - 测试修改设置功能
   - 验证健康收益计算

## 总结

这次修改将戒烟天数的计算逻辑从**基于签到**改为**基于日期**，使得：

- ✅ 戒烟天数更真实反映戒烟时长
- ✅ 健康收益持续增长，不受签到影响
- ✅ 签到功能独立，用于记录坚持情况
- ✅ 用户体验更好，不会因忘记签到而"损失"天数
- ✅ 逻辑更清晰，数据更准确

这是一个更符合实际使用场景的设计！
